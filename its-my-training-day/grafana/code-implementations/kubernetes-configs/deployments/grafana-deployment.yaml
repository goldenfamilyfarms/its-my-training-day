# =============================================================================
# Grafana Deployment - Production-Ready Configuration
# =============================================================================
#
# This manifest demonstrates a production-ready Grafana deployment with:
# - Resource requests and limits for proper scheduling and resource management
# - Liveness and readiness probes for health monitoring
# - ConfigMap for Grafana configuration
# - Secret for sensitive credentials
# - Security context for running with minimal privileges
# - Volume mounts for persistent data and configuration
#
# Best Practices Demonstrated:
# 1. Separation of configuration from container images
# 2. Proper health checking for Kubernetes orchestration
# 3. Resource management for cluster stability
# 4. Security hardening with non-root user and read-only filesystem
# 5. Environment-specific configuration via ConfigMaps and Secrets
#
# Usage:
#   kubectl apply -f grafana-deployment.yaml -n monitoring
#
# Prerequisites:
#   - Kubernetes cluster v1.25+
#   - Storage class for persistent volumes
#   - Namespace 'monitoring' created
#
# =============================================================================

---
# =============================================================================
# ConfigMap: Grafana Configuration
# =============================================================================
# ConfigMaps store non-sensitive configuration data as key-value pairs.
# This allows configuration changes without rebuilding container images.
#
# Key Benefits:
# - Environment-specific configurations (dev, staging, prod)
# - Easy updates without pod restarts (when using subPath)
# - Version control friendly
# - Separation of concerns
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-config
  namespace: monitoring
  labels:
    app: grafana
    component: config
    # Labels help with resource organization and selection
    # Use consistent labeling across all resources
data:
  # grafana.ini is the main configuration file for Grafana
  # This configuration is mounted as a file in the container
  grafana.ini: |
    # ==========================================================================
    # Grafana Server Configuration
    # ==========================================================================
    [server]
    # Protocol (http or https)
    protocol = http
    
    # The http port to bind to
    http_port = 3000
    
    # The public-facing domain name
    # Used for generating links in alerts, dashboards, etc.
    domain = grafana.example.com
    
    # The full public-facing URL
    root_url = %(protocol)s://%(domain)s/
    
    # Serve Grafana from subpath (useful behind reverse proxy)
    # serve_from_sub_path = true
    
    # Enable gzip compression
    enable_gzip = true
    
    # ==========================================================================
    # Database Configuration
    # ==========================================================================
    [database]
    # Grafana uses SQLite by default, but PostgreSQL/MySQL recommended for production
    # type = postgres
    # host = postgres:5432
    # name = grafana
    # user = grafana
    # password = ${GF_DATABASE_PASSWORD}
    
    # For this example, we use SQLite with persistent storage
    type = sqlite3
    path = /var/lib/grafana/grafana.db
    
    # ==========================================================================
    # Security Configuration
    # ==========================================================================
    [security]
    # Disable admin user creation on first start (use secret instead)
    admin_user = admin
    # Password is set via environment variable from secret
    # admin_password = ${GF_SECURITY_ADMIN_PASSWORD}
    
    # Secret key used for signing cookies and other security features
    # In production, set via environment variable
    # secret_key = ${GF_SECURITY_SECRET_KEY}
    
    # Disable gravatar profile images
    disable_gravatar = true
    
    # Cookie settings
    cookie_secure = true
    cookie_samesite = strict
    
    # ==========================================================================
    # Users Configuration
    # ==========================================================================
    [users]
    # Disable user signup
    allow_sign_up = false
    
    # Disable organization creation
    allow_org_create = false
    
    # Auto-assign new users to main organization
    auto_assign_org = true
    auto_assign_org_role = Viewer
    
    # ==========================================================================
    # Authentication Configuration
    # ==========================================================================
    [auth]
    # Disable anonymous access in production
    disable_login_form = false
    
    [auth.anonymous]
    # Disable anonymous access
    enabled = false
    
    # ==========================================================================
    # Logging Configuration
    # ==========================================================================
    [log]
    # Log mode: console, file, syslog
    mode = console
    
    # Log level: debug, info, warn, error, critical
    level = info
    
    # Log format: text, console, json
    # JSON format is better for log aggregation systems like Loki
    format = json
    
    # ==========================================================================
    # Metrics Configuration
    # ==========================================================================
    [metrics]
    # Enable internal metrics
    enabled = true
    
    # Disable sending usage stats to Grafana Labs
    reporting_enabled = false
    
    # ==========================================================================
    # Alerting Configuration
    # ==========================================================================
    [alerting]
    # Enable alerting engine
    enabled = true
    
    # Execute alerts on this instance
    execute_alerts = true
    
    # ==========================================================================
    # Unified Alerting (Grafana 8+)
    # ==========================================================================
    [unified_alerting]
    enabled = true
    
    # ==========================================================================
    # Plugins Configuration
    # ==========================================================================
    [plugins]
    # Enable alpha plugins
    enable_alpha = false
    
    # Plugin catalog URL
    plugin_catalog_url = https://grafana.com/grafana/plugins/
    
    # ==========================================================================
    # Feature Toggles
    # ==========================================================================
    [feature_toggles]
    # Enable specific feature flags
    # enable = feature1,feature2

  # Provisioning configuration for data sources
  # This allows automatic data source configuration on startup
  datasources.yaml: |
    apiVersion: 1
    
    # Delete data sources not defined in this file
    deleteDatasources: []
    
    datasources:
      # Prometheus data source for metrics
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus:9090
        isDefault: true
        editable: false
        jsonData:
          timeInterval: "15s"
          httpMethod: POST
      
      # Loki data source for logs
      - name: Loki
        type: loki
        access: proxy
        url: http://loki:3100
        editable: false
        jsonData:
          maxLines: 1000
      
      # Tempo data source for traces
      - name: Tempo
        type: tempo
        access: proxy
        url: http://tempo:3200
        editable: false
        jsonData:
          tracesToLogs:
            datasourceUid: loki
            tags: ['job', 'instance', 'pod', 'namespace']
            mappedTags: [{ key: 'service.name', value: 'service' }]
            mapTagNamesEnabled: true
            spanStartTimeShift: '-1h'
            spanEndTimeShift: '1h'
            filterByTraceID: true
            filterBySpanID: false

---
# =============================================================================
# Secret: Grafana Credentials
# =============================================================================
# Secrets store sensitive data like passwords, tokens, and keys.
# Data is base64 encoded (NOT encrypted by default).
#
# Security Best Practices:
# 1. Use external secret management (Vault, AWS Secrets Manager, etc.)
# 2. Enable encryption at rest for etcd
# 3. Use RBAC to restrict secret access
# 4. Rotate secrets regularly
# 5. Never commit secrets to version control
#
# In production, consider using:
# - External Secrets Operator
# - Sealed Secrets
# - HashiCorp Vault with CSI driver
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: grafana-secrets
  namespace: monitoring
  labels:
    app: grafana
    component: secrets
type: Opaque
# Using stringData for readability (automatically base64 encoded)
# In production, use 'data' with pre-encoded values or external secret management
stringData:
  # Admin password - CHANGE THIS IN PRODUCTION
  # Use a strong, randomly generated password
  admin-password: "CHANGE_ME_IN_PRODUCTION"
  
  # Secret key for signing - CHANGE THIS IN PRODUCTION
  # Generate with: openssl rand -hex 32
  secret-key: "CHANGE_ME_GENERATE_WITH_OPENSSL_RAND"
  
  # Database password (if using external database)
  # db-password: "database-password-here"

---
# =============================================================================
# PersistentVolumeClaim: Grafana Data Storage
# =============================================================================
# PVCs request storage from the cluster's storage provisioner.
# This ensures Grafana data persists across pod restarts.
#
# Storage Considerations:
# - Size based on expected dashboard count and data retention
# - Access mode depends on deployment strategy (RWO for single replica)
# - Storage class determines performance characteristics
# =============================================================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: grafana-data
  namespace: monitoring
  labels:
    app: grafana
    component: storage
spec:
  accessModes:
    # ReadWriteOnce - can be mounted read-write by a single node
    # Use ReadWriteMany if running multiple replicas (requires supported storage)
    - ReadWriteOnce
  # Storage class - use appropriate class for your cluster
  # Common options: standard, gp2 (AWS), pd-standard (GCP), managed-premium (Azure)
  storageClassName: standard
  resources:
    requests:
      # Size based on expected usage
      # Grafana itself is lightweight, but dashboards and plugins add up
      storage: 5Gi

---
# =============================================================================
# Deployment: Grafana Server
# =============================================================================
# Deployments manage stateless applications with declarative updates.
# They provide:
# - Rolling updates with zero downtime
# - Rollback capabilities
# - Scaling (horizontal pod autoscaling)
# - Self-healing (automatic pod replacement)
#
# For Grafana specifically:
# - Single replica is common for small deployments
# - Multiple replicas require shared database (PostgreSQL/MySQL)
# - Consider using Grafana Enterprise for HA features
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: monitoring
  labels:
    app: grafana
    component: server
    # Version label helps with tracking deployments
    version: "10.0.0"
  annotations:
    # Annotations for documentation and tooling
    description: "Production Grafana deployment with security hardening"
spec:
  # Number of pod replicas
  # For HA, increase replicas and use external database
  replicas: 1
  
  # Selector must match template labels
  selector:
    matchLabels:
      app: grafana
      component: server
  
  # Deployment strategy
  strategy:
    type: RollingUpdate
    rollingUpdate:
      # Maximum number of pods that can be unavailable during update
      maxUnavailable: 0
      # Maximum number of pods that can be created above desired count
      maxSurge: 1
  
  # Pod template specification
  template:
    metadata:
      labels:
        app: grafana
        component: server
        version: "10.0.0"
      annotations:
        # Prometheus scraping configuration
        prometheus.io/scrape: "true"
        prometheus.io/port: "3000"
        prometheus.io/path: "/metrics"
        # Checksum of config to trigger rolling update on config changes
        # In practice, use a tool like Helm to compute this automatically
        # checksum/config: "{{ sha256sum .Values.config }}"
    
    spec:
      # =======================================================================
      # Service Account
      # =======================================================================
      # Use a dedicated service account for RBAC
      serviceAccountName: grafana
      
      # =======================================================================
      # Security Context (Pod Level)
      # =======================================================================
      # Pod-level security settings apply to all containers
      securityContext:
        # Run all containers as non-root user
        runAsNonRoot: true
        # Grafana's default user ID
        runAsUser: 472
        # Group ID for file permissions
        fsGroup: 472
        # Ensure volume permissions are set correctly
        fsGroupChangePolicy: "OnRootMismatch"
      
      # =======================================================================
      # Init Containers
      # =======================================================================
      # Init containers run before main containers
      # Useful for setup tasks, permission fixes, etc.
      initContainers:
        - name: init-chown-data
          image: busybox:1.36
          # Ensure data directory has correct ownership
          command: ['sh', '-c', 'chown -R 472:472 /var/lib/grafana']
          volumeMounts:
            - name: grafana-data
              mountPath: /var/lib/grafana
          securityContext:
            runAsNonRoot: false
            runAsUser: 0
      
      # =======================================================================
      # Containers
      # =======================================================================
      containers:
        - name: grafana
          # Use specific version tag, never 'latest' in production
          image: grafana/grafana:10.0.0
          imagePullPolicy: IfNotPresent
          
          # ==================================================================
          # Ports
          # ==================================================================
          ports:
            - name: http
              containerPort: 3000
              protocol: TCP
          
          # ==================================================================
          # Environment Variables
          # ==================================================================
          env:
            # Admin password from secret
            - name: GF_SECURITY_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: grafana-secrets
                  key: admin-password
            
            # Secret key from secret
            - name: GF_SECURITY_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: grafana-secrets
                  key: secret-key
            
            # Paths configuration
            - name: GF_PATHS_DATA
              value: /var/lib/grafana
            - name: GF_PATHS_LOGS
              value: /var/log/grafana
            - name: GF_PATHS_PLUGINS
              value: /var/lib/grafana/plugins
            - name: GF_PATHS_PROVISIONING
              value: /etc/grafana/provisioning
          
          # ==================================================================
          # Resource Requests and Limits
          # ==================================================================
          # Critical for cluster stability and proper scheduling
          #
          # Requests: Minimum resources guaranteed to the container
          # Limits: Maximum resources the container can use
          #
          # Best Practices:
          # - Set requests based on normal operation
          # - Set limits based on peak usage + buffer
          # - Monitor actual usage and adjust accordingly
          # ==================================================================
          resources:
            requests:
              # Minimum CPU (100m = 0.1 CPU core)
              cpu: "100m"
              # Minimum memory
              memory: "256Mi"
            limits:
              # Maximum CPU
              cpu: "500m"
              # Maximum memory
              memory: "512Mi"
          
          # ==================================================================
          # Liveness Probe
          # ==================================================================
          # Determines if the container is running properly
          # If it fails, Kubernetes restarts the container
          #
          # Configuration Guidelines:
          # - initialDelaySeconds: Time for app to start
          # - periodSeconds: How often to check
          # - timeoutSeconds: How long to wait for response
          # - failureThreshold: Failures before restart
          # ==================================================================
          livenessProbe:
            httpGet:
              path: /api/health
              port: http
            # Wait for Grafana to start before checking
            initialDelaySeconds: 60
            # Check every 10 seconds
            periodSeconds: 10
            # Wait up to 5 seconds for response
            timeoutSeconds: 5
            # Restart after 3 consecutive failures
            failureThreshold: 3
          
          # ==================================================================
          # Readiness Probe
          # ==================================================================
          # Determines if the container is ready to receive traffic
          # If it fails, the pod is removed from service endpoints
          #
          # Readiness probes should be more sensitive than liveness probes
          # to quickly remove unhealthy pods from load balancing
          # ==================================================================
          readinessProbe:
            httpGet:
              path: /api/health
              port: http
            # Start checking sooner than liveness
            initialDelaySeconds: 10
            # Check more frequently
            periodSeconds: 5
            # Shorter timeout
            timeoutSeconds: 3
            # Remove from service after 1 failure
            failureThreshold: 1
            # Add back after 1 success
            successThreshold: 1
          
          # ==================================================================
          # Startup Probe (Kubernetes 1.18+)
          # ==================================================================
          # Disables liveness/readiness probes until startup succeeds
          # Useful for slow-starting containers
          # ==================================================================
          startupProbe:
            httpGet:
              path: /api/health
              port: http
            # Allow up to 5 minutes for startup (30 * 10s)
            failureThreshold: 30
            periodSeconds: 10
          
          # ==================================================================
          # Security Context (Container Level)
          # ==================================================================
          securityContext:
            # Prevent privilege escalation
            allowPrivilegeEscalation: false
            # Read-only root filesystem
            # Requires writable volumes for data/logs
            readOnlyRootFilesystem: true
            # Drop all capabilities
            capabilities:
              drop:
                - ALL
          
          # ==================================================================
          # Volume Mounts
          # ==================================================================
          volumeMounts:
            # Grafana data directory (dashboards, plugins, etc.)
            - name: grafana-data
              mountPath: /var/lib/grafana
            
            # Grafana configuration file
            - name: grafana-config
              mountPath: /etc/grafana/grafana.ini
              subPath: grafana.ini
              readOnly: true
            
            # Data source provisioning
            - name: grafana-config
              mountPath: /etc/grafana/provisioning/datasources/datasources.yaml
              subPath: datasources.yaml
              readOnly: true
            
            # Temporary directory for read-only root filesystem
            - name: tmp
              mountPath: /tmp
            
            # Log directory
            - name: logs
              mountPath: /var/log/grafana
      
      # =======================================================================
      # Volumes
      # =======================================================================
      volumes:
        # Persistent storage for Grafana data
        - name: grafana-data
          persistentVolumeClaim:
            claimName: grafana-data
        
        # ConfigMap containing Grafana configuration
        - name: grafana-config
          configMap:
            name: grafana-config
        
        # EmptyDir for temporary files
        - name: tmp
          emptyDir: {}
        
        # EmptyDir for logs
        - name: logs
          emptyDir: {}
      
      # =======================================================================
      # Node Selection and Affinity
      # =======================================================================
      # Control which nodes the pod can be scheduled on
      
      # Node selector - simple key-value matching
      # nodeSelector:
      #   kubernetes.io/os: linux
      #   node-type: monitoring
      
      # Tolerations - allow scheduling on tainted nodes
      tolerations:
        # Tolerate master/control-plane nodes (for small clusters)
        - key: "node-role.kubernetes.io/control-plane"
          operator: "Exists"
          effect: "NoSchedule"
      
      # Affinity rules for advanced scheduling
      affinity:
        # Prefer scheduling on nodes with SSD storage
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: node.kubernetes.io/instance-type
                    operator: In
                    values:
                      - m5.large
                      - m5.xlarge
        
        # Anti-affinity to spread replicas across nodes (for HA)
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app: grafana
                topologyKey: kubernetes.io/hostname
      
      # =======================================================================
      # DNS and Networking
      # =======================================================================
      # DNS policy for the pod
      dnsPolicy: ClusterFirst
      
      # Termination grace period
      # Time to wait for graceful shutdown before SIGKILL
      terminationGracePeriodSeconds: 30

---
# =============================================================================
# ServiceAccount: Grafana
# =============================================================================
# Service accounts provide identity for pods
# Used for RBAC and accessing Kubernetes API
# =============================================================================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: grafana
  namespace: monitoring
  labels:
    app: grafana
# Disable automatic token mounting if not needed
# automountServiceAccountToken: false
